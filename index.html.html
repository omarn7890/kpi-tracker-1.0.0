<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real Estate SMS Campaign KPI Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
            font-weight: 700;
            font-size: 2.5em;
        }
        
        .connection-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            border-radius: 8px;
            font-weight: 600;
        }
        
        .connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .disconnected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .setup-section {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        
        .setup-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .setup-instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #2196f3;
        }
        
        .setup-instructions ol {
            margin-left: 20px;
        }
        
        .setup-instructions li {
            margin-bottom: 8px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .kpi-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.12);
        }
        
        .kpi-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .kpi-title {
            font-size: 1.1em;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .kpi-value {
            font-size: 2.5em;
            font-weight: 700;
            color: #3498db;
            margin-bottom: 10px;
        }
        
        .kpi-percentage {
            font-size: 1.2em;
            font-weight: 600;
        }
        
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #f39c12; }
        
        .input-section {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        
        .input-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        input, select, textarea {
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
            background: white;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }
        
        .btn {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.3);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .list-performance {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        
        .list-performance h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .list-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .list-item {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #3498db;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        }
        
        .list-name {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .list-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-size: 0.9em;
        }
        
        .stat-item {
            display: flex;
            justify-content: space-between;
        }
        
        .notes-section {
            background: linear-gradient(145deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        }
        
        .notes-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .notes-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .note-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #f39c12;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .export-section {
            text-align: center;
            margin-top: 30px;
        }
        
        .hidden {
            display: none;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .input-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Real Estate SMS Campaign KPI Tracker</h1>
        
        <!-- Connection Status -->
        <div id="connectionStatus" class="connection-status disconnected">
            üî¥ Not connected to Google Sheets
        </div>
        
        <!-- Google Sheets Setup -->
        <div class="setup-section">
            <h3>üîó Google Sheets Integration Setup</h3>
            <div class="setup-instructions">
                <strong>Setup Instructions:</strong>
                <ol>
                    <li>Go to <a href="https://console.developers.google.com/" target="_blank">Google Cloud Console</a></li>
                    <li>Create a new project or select existing one</li>
                    <li>Enable the Google Sheets API</li>
                    <li>Create credentials (API Key)</li>
                    <li>Enable Google Apps Script API</li>
                    <li>Copy your API key below</li>
                </ol>
            </div>
            <div class="input-grid">
                <div class="input-group">
                    <label for="apiKey">Google Sheets API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your API key">
                </div>
                <div class="input-group">
                    <label for="spreadsheetId">Spreadsheet ID (from URL)</label>
                    <input type="text" id="spreadsheetId" value="1b6KnMtbZmTDqWvo_dUrMWcpjC_Z8SVFqC6BZBv57yIM" placeholder="Spreadsheet ID">
                </div>
            </div>
            <button class="btn btn-success" onclick="connectToGoogleSheets()">Connect to Google Sheets</button>
            <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
        </div>
        
        <!-- Main KPI Dashboard -->
        <div class="dashboard-grid">
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">üì± Total Messages Sent</span>
                </div>
                <div class="kpi-value" id="totalSent">0</div>
                <div class="kpi-percentage neutral">This Week: <span id="weekSent">0</span></div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">üí¨ Response Rate</span>
                </div>
                <div class="kpi-value" id="responseRate">0%</div>
                <div class="kpi-percentage" id="responseRateChange">Industry Avg: 2-5%</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">üìû Appointment Rate</span>
                </div>
                <div class="kpi-value" id="appointmentRate">0%</div>
                <div class="kpi-percentage" id="appointmentRateChange">Of Responses</div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">üè† Contracts Signed</span>
                </div>
                <div class="kpi-value" id="contractsSigned">0</div>
                <div class="kpi-percentage" id="contractRate">Conversion Rate: <span>0%</span></div>
            </div>
            
            <div class="kpi-card">
                <div class="kpi-header">
                    <span class="kpi-title">üí∏ Cost Per Deal</span>
                </div>
                <div class="kpi-value" id="costPerDeal">$0</div>
                <div class="kpi-percentage neutral">Total Spend: $<span id="totalSpend">0</span></div>
            </div>
        </div>
        
        <!-- Data Input Section -->
        <div class="input-section">
            <h3>üìù Add Campaign Data</h3>
            <div class="input-grid">
                <div class="input-group">
                    <label for="listName">List Name (Custom)</label>
                    <input type="text" id="listName" placeholder="Enter custom list name">
                </div>
                
                <div class="input-group">
                    <label for="averagePerformance">Average List Performance (%)</label>
                    <input type="number" id="averagePerformance" step="0.1" placeholder="e.g., 3.5">
                </div>
                
                <div class="input-group">
                    <label for="messagesSent">Messages Sent</label>
                    <input type="number" id="messagesSent" placeholder="Enter number">
                </div>
                
                <div class="input-group">
                    <label for="responses">Responses Received</label>
                    <input type="number" id="responses" placeholder="Enter number">
                </div>
                
                <div class="input-group">
                    <label for="appointments">Appointments Set</label>
                    <input type="number" id="appointments" placeholder="Enter number">
                </div>
                
                <div class="input-group">
                    <label for="contracts">Contracts Signed</label>
                    <input type="number" id="contracts" placeholder="Enter number">
                </div>
                
                <div class="input-group">
                    <label for="campaignCost">Campaign Cost ($)</label>
                    <input type="number" id="campaignCost" placeholder="Enter cost">
                </div>
            </div>
            
            <button class="btn" onclick="addCampaignData()">Add Data</button>
            <button class="btn btn-success" onclick="syncToGoogleSheets()">Sync to Google Sheets</button>
            <button class="btn btn-secondary" onclick="clearAllData()">Clear All Data</button>
        </div>
        
        <!-- List Performance Breakdown -->
        <div class="list-performance">
            <h3>üìà Performance by List Type</h3>
            <div class="list-grid" id="listPerformance">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
        
        <!-- Key Insights & Notes -->
        <div class="notes-section">
            <h3>üí° Key Insights & Optimization Notes</h3>
            <div class="notes-grid" id="insightsGrid">
                <!-- Dynamic insights will be generated here -->
            </div>
        </div>
        
        <!-- Export Section -->
        <div class="export-section">
            <button class="btn" onclick="exportData()">üìä Export Data to CSV</button>
            <button class="btn btn-warning" onclick="loadFromGoogleSheets()">üì• Load from Google Sheets</button>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Data storage
        let campaignData = [];
        let isGoogleSheetsConnected = false;
        let gapi_loaded = false;
        let API_KEY = '';
        let SPREADSHEET_ID = '1b6KnMtbZmTDqWvo_dUrMWcpjC_Z8SVFqC6BZBv57yIM';
        let SHEET_NAME = 'Sheet1'; // Adjust if your sheet has a different name
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadStoredCredentials();
            updateDashboard();
            updateListPerformance();
            generateInsights();
        });
        
        function loadStoredCredentials() {
            const storedApiKey = localStorage.getItem('googleSheetsApiKey');
            const storedSpreadsheetId = localStorage.getItem('spreadsheetId');
            
            if (storedApiKey) {
                document.getElementById('apiKey').value = storedApiKey;
                API_KEY = storedApiKey;
            }
            
            if (storedSpreadsheetId) {
                document.getElementById('spreadsheetId').value = storedSpreadsheetId;
                SPREADSHEET_ID = storedSpreadsheetId;
            }
        }
        
        function connectToGoogleSheets() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            
            if (!apiKey || !spreadsheetId) {
                alert('Please enter both API Key and Spreadsheet ID');
                return;
            }
            
            API_KEY = apiKey;
            SPREADSHEET_ID = spreadsheetId;
            
            // Store credentials
            localStorage.setItem('googleSheetsApiKey', apiKey);
            localStorage.setItem('spreadsheetId', spreadsheetId);
            
            // Initialize Google API
            gapi.load('client', initializeGapi);
        }
        
        function initializeGapi() {
            gapi.client.init({
                apiKey: API_KEY,
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(function() {
                isGoogleSheetsConnected = true;
                updateConnectionStatus(true);
                console.log('Google Sheets API initialized successfully');
            }).catch(function(error) {
                console.error('Error initializing Google API:', error);
                updateConnectionStatus(false);
                alert('Error connecting to Google Sheets. Please check your API key and try again.');
            });
        }
        
        function updateConnectionStatus(connected) {
            const statusDiv = document.getElementById('connectionStatus');
            if (connected) {
                statusDiv.className = 'connection-status connected';
                statusDiv.textContent = 'üü¢ Connected to Google Sheets';
                isGoogleSheetsConnected = true;
            } else {
                statusDiv.className = 'connection-status disconnected';
                statusDiv.textContent = 'üî¥ Not connected to Google Sheets';
                isGoogleSheetsConnected = false;
            }
        }
        
        function testConnection() {
            if (!API_KEY) {
                alert('Please enter your API key first');
                return;
            }
            
            gapi.load('client', function() {
                gapi.client.init({
                    apiKey: API_KEY,
                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
                }).then(function() {
                    return gapi.client.sheets.spreadsheets.get({
                        spreadsheetId: SPREADSHEET_ID
                    });
                }).then(function(response) {
                    alert('‚úÖ Connection successful! Spreadsheet title: ' + response.result.properties.title);
                    updateConnectionStatus(true);
                }).catch(function(error) {
                    console.error('Connection test failed:', error);
                    alert('‚ùå Connection failed. Please check your API key and Spreadsheet ID.');
                    updateConnectionStatus(false);
                });
            });
        }
        
        function addCampaignData() {
            const listName = document.getElementById('listName').value.trim();
            const averagePerformance = parseFloat(document.getElementById('averagePerformance').value) || 0;
            const messagesSent = parseInt(document.getElementById('messagesSent').value) || 0;
            const responses = parseInt(document.getElementById('responses').value) || 0;
            const appointments = parseInt(document.getElementById('appointments').value) || 0;
            const contracts = parseInt(document.getElementById('contracts').value) || 0;
            const campaignCost = parseFloat(document.getElementById('campaignCost').value) || 0;
            
            if (!listName || messagesSent === 0) {
                alert('Please enter list name and number of messages sent');
                return;
            }
            
            // Calculate actual performance vs average
            const actualResponseRate = (responses / messagesSent * 100);
            const performanceVsAverage = averagePerformance > 0 ? 
                ((actualResponseRate - averagePerformance) / averagePerformance * 100) : 0;
            
            const newEntry = {
                id: Date.now(),
                date: new Date().toISOString().split('T')[0],
                listName,
                averagePerformance,
                messagesSent,
                responses,
                appointments,
                contracts,
                campaignCost,
                responseRate: actualResponseRate.toFixed(2),
                appointmentRate: responses > 0 ? (appointments / responses * 100).toFixed(2) : 0,
                contractRate: appointments > 0 ? (contracts / appointments * 100).toFixed(2) : 0,
                costPerDeal: contracts > 0 ? (campaignCost / contracts).toFixed(2) : 0,
                performanceVsAverage: performanceVsAverage.toFixed(1)
            };
            
            campaignData.push(newEntry);
            
            // Clear form
            document.getElementById('listName').value = '';
            document.getElementById('averagePerformance').value = '';
            document.getElementById('messagesSent').value = '';
            document.getElementById('responses').value = '';
            document.getElementById('appointments').value = '';
            document.getElementById('contracts').value = '';
            document.getElementById('campaignCost').value = '';
            
            updateDashboard();
            updateListPerformance();
            generateInsights();
            
            alert('Campaign data added successfully!');
        }
        
        function syncToGoogleSheets() {
            if (!isGoogleSheetsConnected) {
                alert('Please connect to Google Sheets first');
                return;
            }
            
            if (campaignData.length === 0) {
                alert('No data to sync');
                return;
            }
            
            // Prepare data for Google Sheets
            const headers = [
                'Date', 'List Name', 'Average Performance (%)', 'Messages Sent', 
                'Responses', 'Response Rate (%)', 'Performance vs Average (%)',
                'Appointments', 'Appointment Rate (%)', 'Contracts', 
                'Contract Rate (%)', 'Campaign Cost ($)', 'Cost Per Deal ($)'
            ];
            
            const rows = campaignData.map(entry => [
                entry.date,
                entry.listName,
                entry.averagePerformance,
                entry.messagesSent,
                entry.responses,
                entry.responseRate,
                entry.performanceVsAverage,
                entry.appointments,
                entry.appointmentRate,
                entry.contracts,
                entry.contractRate,
                entry.campaignCost,
                entry.costPerDeal
            ]);
            
            const values = [headers, ...rows];
            
            gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId: SPREADSHEET_ID,
                range: SHEET_NAME + '!A1',
                valueInputOption: 'RAW',
                resource: {
                    values: values
                }
            }).then(function(response) {
                alert('‚úÖ Data successfully synced to Google Sheets!');
                console.log('Sync successful:', response);
            }).catch(function(error) {
                console.error('Sync error:', error);
                alert('‚ùå Error syncing to Google Sheets. Please check your permissions and try again.');
            });
        }
        
        function loadFromGoogleSheets() {
            if (!isGoogleSheetsConnected) {
                alert('Please connect to Google Sheets first');
                return;
            }
            
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: SPREADSHEET_ID,
                range: SHEET_NAME + '!A1:M1000',
            }).then(function(response) {
                const values = response.result.values;
                if (!values || values.length < 2) {
                    alert('No data found in the spreadsheet');
                    return;
                }
                
                // Skip header row and convert to campaign data format
                campaignData = [];
                for (let i = 1; i < values.length; i++) {
                    const row = values[i];
                    if (row.length >= 6 && row[3]) { // Ensure minimum required fields
                        campaignData.push({
                            id: Date.now() + i,
                            date: row[0] || new Date().toISOString().split('T')[0],
                            listName: row[1] || 'Unknown',
                            averagePerformance: parseFloat(row[2]) || 0,
                            messagesSent: parseInt(row[3]) || 0,
                            responses: parseInt(row[4]) || 0,
                            responseRate: parseFloat(row[5]) || 0,
                            performanceVsAverage: parseFloat(row[6]) || 0,
                            appointments: parseInt(row[7]) || 0,
                            appointmentRate: parseFloat(row[8]) || 0,
                            contracts: parseInt(row[9]) || 0,
                            contractRate: parseFloat(row[10]) || 0,
                            campaignCost: parseFloat(row[11]) || 0,
                            costPerDeal: parseFloat(row[12]) || 0
                        });
                    }
                }
                
                updateDashboard();
                updateListPerformance();
                generateInsights();
                
                alert(`‚úÖ Successfully loaded ${campaignData.length} records from Google Sheets!`);
            }).catch(function(error) {
                console.error('Load error:', error);
                alert('‚ùå Error loading from Google Sheets. Please check your permissions and try again.');
            });
        }
        
        function updateDashboard() {
            if (campaignData.length === 0) return;
            
            const totals = campaignData.reduce((acc, curr) => {
                acc.messagesSent += curr.messagesSent;
                acc.responses += curr.responses;
                acc.appointments += curr.appointments;
                acc.contracts += curr.contracts;
                acc.campaignCost += curr.campaignCost;
                return acc;
            }, { messagesSent: 0, responses: 0, appointments: 0, contracts: 0, campaignCost: 0 });
            
            // Calculate rates
            const responseRate = totals.messagesSent > 0 ? (totals.responses / totals.messagesSent * 100).toFixed(1) : 0;
            const appointmentRate = totals.responses > 0 ? (totals.appointments / totals.responses * 100).toFixed(1) : 0;
            const contractRate = totals.messagesSent > 0 ? (totals.contracts / totals.messagesSent * 100).toFixed(2) : 0;
            const costPerDeal = totals.contracts > 0 ? (totals.campaignCost / totals.contracts).toFixed(2) : 0;
            
            // Update DOM
            document.getElementById('totalSent').textContent = totals.messagesSent.toLocaleString();
            document.getElementById('responseRate').textContent = responseRate + '%';
            document.getElementById('appointmentRate').textContent = appointmentRate + '%';
            document.getElementById('contractsSigned').textContent = totals.contracts;
            document.getElementById('costPerDeal').textContent = totals.contracts > 0 ? '$' + costPerDeal : 'N/A';
            document.getElementById('totalSpend').textContent = totals.campaignCost.toFixed(2);
            
            // Update contract rate display
            document.querySelector('#contractRate span').textContent = contractRate + '%';
            
            // Color coding for response rate
            const responseRateElement = document.getElementById('responseRateChange');
            if (responseRate >= 5) {
                responseRateElement.className = 'kpi-percentage positive';
                responseRateElement.textContent = 'üî• Excellent Performance!';
            } else if (responseRate >= 2) {
                responseRateElement.className = 'kpi-percentage neutral';
                responseRateElement.textContent = '‚úÖ Industry Average';
            } else {
                responseRateElement.className = 'kpi-percentage negative';
                responseRateElement.textContent = '‚ö†Ô∏è Below Average';
            }
        }
        
        function updateListPerformance() {
            const listPerformanceDiv = document.getElementById('listPerformance');
            
            // Group data by list name
            const listStats = {};
            campaignData.forEach(entry => {
                if (!listStats[entry.listName]) {
                    listStats[entry.listName] = {
                        messagesSent: 0,
                        responses: 0,
                        appointments: 0,
                        contracts: 0,
                        cost: 0,
                        averagePerformance: 0,
                        performanceVsAverage: []
                    };
                }
                listStats[entry.listName].messagesSent += entry.messagesSent;
                listStats[entry.listName].responses += entry.responses;
                listStats[entry.listName].appointments += entry.appointments;
                listStats[entry.listName].contracts += entry.contracts;
                listStats[entry.listName].cost += entry.campaignCost;
                listStats[entry.listName].averagePerformance = entry.averagePerformance;
                listStats[entry.listName].performanceVsAverage.push(parseFloat(entry.performanceVsAverage));
            });
            
            let html = '';
            Object.entries(listStats).forEach(([listName, stats]) => {
                const responseRate = stats.messagesSent > 0 ? (stats.responses / stats.messagesSent * 100).toFixed(1) : 0;
                const avgPerformanceVsAverage = stats.performanceVsAverage.length > 0 ? 
                    (stats.performanceVsAverage.reduce((a, b) => a + b, 0) / stats.performanceVsAverage.length).toFixed(1) : 0;
                
                html += `
                    <div class="list-item">
                        <div class="list-name">${listName}</div>
                        <div class="list-stats">
                            <div class="stat-item">
                                <span>Messages:</span>
                                <span>${stats.messagesSent}</span>
                            </div>
                            <div class="stat-item">
                                <span>Response Rate:</span>
                                <span>${responseRate}%</span>
                            </div>
                            <div class="stat-item">
                                <span>Avg Expected:</span>
                                <span>${stats.averagePerformance}%</span>
                            </div>
                            <div class="stat-item">
                                <span>vs Average:</span>
                                <span style="color: ${avgPerformanceVsAverage >= 0 ? '#27ae60' : '#e74c3c'}">${avgPerformanceVsAverage}%</span>
                            </div>
                            <div class="stat-item">
                                <span>Appointments:</span>
                                <span>${stats.appointments}</span>
                            </div>
                            <div class="stat-item">
                                <span>Contracts:</span>
                                <span>${stats.contracts}</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            listPerformanceDiv.innerHTML = html || '<p>No data available yet. Add some campaign data to see performance by list type.</p>';
        }
        
        function generateInsights() {
            const insightsDiv = document.getElementById('insightsGrid');
            
            if (campaignData.length === 0) {
                insightsDiv.innerHTML = '<p>Add campaign data to generate insights and optimization recommendations.</p>';
                return;
            }
            
            const insights = [];
            
            // Group by list name for analysis
            const listStats = {};
            campaignData.forEach(entry => {
                if (!listStats[entry.listName]) {
                    listStats[entry.listName] = { 
                        entries: [], 
                        totalCost: 0, 
                        totalLeads: 0,
                        performanceVsAverage: []
                    };
                }
                listStats[entry.listName].entries.push(entry);
                listStats[entry.listName].totalCost += entry.campaignCost;
                listStats[entry.listName].totalLeads += entry.responses;
                listStats[entry.listName].performanceVsAverage.push(parseFloat(entry.performanceVsAverage));
            });
            
            // Find best performing list vs expectations
            let bestPerformingList = { name: '', performance: -Infinity };
            Object.entries(listStats).forEach(([listName, data]) => {
                const avgPerformanceVsAverage = data.performanceVsAverage.reduce((a, b) => a + b, 0) / data.performanceVsAverage.length;
                if (avgPerformanceVsAverage > bestPerformingList.performance) {
                    bestPerformingList = { name: listName, performance: avgPerformanceVsAverage.toFixed(1) };
                }
            });
            
            if (bestPerformingList.name) {
                if (bestPerformingList.performance > 0) {
                    insights.push(`üèÜ ${bestPerformingList.name} is outperforming expectations by ${bestPerformingList.performance}%! Consider increasing budget allocation.`);
                } else {
                    insights.push(`‚ö†Ô∏è ${bestPerformingList.name} is underperforming expectations by ${Math.abs(bestPerformingList.performance)}%. Review messaging or list quality.`);
                }
            }
            
            // Overall performance insights
            const totalMessages = campaignData.reduce((sum, entry) => sum + entry.messagesSent, 0);
            const totalResponses = campaignData.reduce((sum, entry) => sum + entry.responses, 0);
            const overallRate = totalMessages > 0 ? (totalResponses / totalMessages * 100).toFixed(1) : 0;
            
            if (overallRate >= 5) {
                insights.push(`üî• Outstanding overall response rate of ${overallRate}%! You're outperforming industry standards.`);
            } else if (overallRate < 2) {
                insights.push(`‚ö†Ô∏è Response rate of ${overallRate}% is below average. Consider testing new message templates or improving list quality.`);
            }
            
            // Performance vs expectations analysis
            const avgPerformanceVsExpected = campaignData.reduce((sum, entry) => sum + parseFloat(entry.performanceVsAverage), 0) / campaignData.length;
            if (avgPerformanceVsExpected > 10) {
                insights.push(`üéØ Your campaigns are consistently exceeding expectations by ${avgPerformanceVsExpected.toFixed(1)}% on average!`);
            } else if (avgPerformanceVsExpected < -10) {
                insights.push(`üìâ Campaigns are underperforming expectations by ${Math.abs(avgPerformanceVsExpected).toFixed(1)}% on average. Consider strategy adjustments.`);
            }
            
            // Cost efficiency insights
            const avgCostPerDeal = campaignData.filter(entry => entry.contracts > 0)
                .reduce((sum, entry) => sum + parseFloat(entry.costPerDeal || 0), 0) / 
                campaignData.filter(entry => entry.contracts > 0).length;
            
            if (avgCostPerDeal && avgCostPerDeal > 1000) {
                insights.push(`üí∞ Cost per deal averaging ${avgCostPerDeal.toFixed(2)} is high. Focus on improving conversion rates.`);
            } else if (avgCostPerDeal && avgCostPerDeal < 500) {
                insights.push(`üíö Excellent cost efficiency! ${avgCostPerDeal.toFixed(2)} per deal is very competitive.`);
            }
            
            // Add general recommendations
            insights.push(`üìä Recommended: Compare actual performance against your expected averages to identify winning strategies.`);
            insights.push(`‚è∞ Best practice: Respond to interested leads within 15 minutes to maximize conversion rates.`);
            
            let html = '';
            insights.forEach(insight => {
                html += `<div class="note-item">${insight}</div>`;
            });
            
            insightsDiv.innerHTML = html;
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear all campaign data? This cannot be undone.')) {
                campaignData = [];
                updateDashboard();
                updateListPerformance();
                generateInsights();
                
                // Reset display values
                document.getElementById('totalSent').textContent = '0';
                document.getElementById('responseRate').textContent = '0%';
                document.getElementById('appointmentRate').textContent = '0%';
                document.getElementById('contractsSigned').textContent = '0';
                document.getElementById('costPerDeal').textContent = '$0';
                document.getElementById('totalSpend').textContent = '0';
                document.querySelector('#contractRate span').textContent = '0%';
                
                alert('All data cleared successfully!');
            }
        }
        
        function exportData() {
            if (campaignData.length === 0) {
                alert('No data to export');
                return;
            }
            
            const headers = [
                'Date', 'List Name', 'Average Performance (%)', 'Messages Sent', 
                'Responses', 'Response Rate (%)', 'Performance vs Average (%)',
                'Appointments', 'Appointment Rate (%)', 'Contracts', 
                'Contract Rate (%)', 'Campaign Cost ($)', 'Cost Per Deal ($)'
            ];
            
           const csvContent = [
    headers.join(','),
    ...campaignData.map(entry => [
        entry.date,
        entry.listName,
        entry.averagePerformance,
        entry.messagesSent,
        entry.responses,
        entry.responseRate + '%',
        entry.performanceVsAverage + '%',
        entry.appointments,
        entry.appointmentRate + '%',
        entry.contracts,
        entry.contractRate + '%',
        entry.campaignCost,
        entry.costPerDeal ? entry.costPerDeal : 'N/A'
    ].join(','))
].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sms-campaign-data-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            alert('Data exported successfully!');
        }
    </script>
</body>
</html>